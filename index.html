<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>DVD</title>
<meta name="theme-color" content="#22c55e" />
<style>
:root{
  --bg:#fdf8e5;
  --panel:#fffdf5;
  --border:#e7dca8;
  --text:#3a2e0a;
  --accent:#22c55e;
  --shadow:0 4px 16px rgba(0,0,0,.1);
  --sticky-bg:#fffce6;
}

html,body{
  margin:0;
  height:100%;
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
  background:var(--bg);
  color:var(--text);
}

/* HEADER */
header{
  background:linear-gradient(180deg,#fffbea,#f3e9b5);
  border-bottom:1px solid var(--border);
  box-shadow:0 2px 5px rgba(0,0,0,.05);
  position:sticky;
  top:0;
  z-index:20;
}
.wrap{
  max-width:1200px;
  margin:0 auto;
  padding:12px 16px;
}
h1{
  margin:0;
  font-size:20px;
  font-weight:700;
  color:#3a2e0a;
  line-height:1.2;
  display:flex;
  align-items:center;
  flex-wrap:wrap;
  gap:.5rem;
}
#filmCount{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  background:#a7d0ff;
  color:#0c3a5e;
  border-radius:50%;
  font-weight:700;
  width:26px;
  height:26px;
  font-size:13px;
  line-height:1;
  box-shadow:0 1px 3px rgba(0,0,0,.15);
}
.header-meta{
  font-size:12px;
  color:#6b5a1d;
  font-weight:500;
  margin-top:2px;
}

/* toolbar */
.toolbar{
  display:flex;
  flex-wrap:wrap;
  row-gap:.5rem;
  column-gap:.5rem;
  align-items:center;
  margin-top:10px;
}
.btn{
  appearance:none;
  border:1px solid rgba(22,163,74,.4);
  background:linear-gradient(180deg,rgba(34,197,94,.25),rgba(22,163,74,.15));
  color:#084c24;
  font-weight:600;
  padding:.55rem .8rem;
  border-radius:8px;
  cursor:pointer;
  transition:.2s transform,.2s background;
  box-shadow:var(--shadow);
  font-size:14px;
  line-height:1.2;
}
.btn:hover{
  transform:translateY(-1px);
  background:linear-gradient(180deg,rgba(34,197,94,.35),rgba(22,163,74,.25));
}
.btn.secondary{
  border:1px solid #d6b54a;
  background:linear-gradient(180deg,#fff1b8,#f9e58a);
  color:#3a2e0a;
}
.btn.danger{
  border:1px solid #f87171;
  background:linear-gradient(180deg,#ffe4e6,#fecaca);
  color:#7f1d1d;
}
.btn.lock-toggle.unlocked{
  border:1px solid rgba(22,163,74,.4);
  background:linear-gradient(180deg,rgba(34,197,94,.25),rgba(22,163,74,.15));
  color:#084c24;
}
.btn.lock-toggle.locked{
  border:1px solid #f87171;
  background:linear-gradient(180deg,#ffe4e6,#fecaca);
  color:#7f1d1d;
}
.btn[disabled],
.icon-btn[disabled]{
  opacity:.5;
  cursor:not-allowed;
  filter:grayscale(1);
}
input[type="file"]{
  display:none;
}

/* filtres WW1/WW2/etc */
.filters{
  display:flex;
  flex-wrap:wrap;
  gap:.4rem;
  margin-left:auto;
}
.chipbtn{
  border:1px solid #e5d58e;
  background:#fff7cf;
  color:#5f4f19;
  padding:.4rem .6rem;
  border-radius:999px;
  cursor:pointer;
  font-weight:600;
  font-size:14px;
  line-height:1.2;
}
.chipbtn.active{
  border-color:#b79a2e;
  background:#ffe98a;
}
.chipbtn[data-v="WW1"]{background:#eaf4ff;border-color:#b9d6ff;color:#113a74;}
.chipbtn[data-v="WW2"]{background:#eef6d3;border-color:#cfe7a5;color:#3c4b1f;}
.chipbtn[data-v="Autres"]{background:#f2f2f2;border-color:#dedede;color:#4b5563;}

/* PANEL / TABLE */
.panel{
  margin:12px auto;
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:10px;
  box-shadow:var(--shadow);
}
.table-wrap{
  overflow:auto;
  max-height:calc(100vh - 300px);
}
table{
  border-collapse:separate;
  border-spacing:0;
  width:100%;
  min-width:1000px;
}
thead th{
  position:sticky;
  top:0;
  background:#fff8dc;
  border-bottom:2px solid var(--border);
  padding:.5rem;
  text-align:left;
  user-select:none;
  font-weight:600;
  color:#3a2e0a;
  z-index:10;
  font-size:14px;
  line-height:1.2;
  white-space:nowrap;
}
thead th.sortable{
  cursor:pointer;
}
thead th .sortmark{
  color:#6b5a1d;
  font-size:12px;
  margin-left:.35rem;
}
tbody td{
  border-bottom:1px solid #efe3b5;
  padding:.4rem .5rem;
  vertical-align:middle;
  background:#fffdf5;
  font-size:14px;
  line-height:1.3;
}
tbody tr:hover td{
  background:#fffbe1;
}

/* Sticky N¬∫ + Titre */
th.sticky-num,
td.sticky-num{
  position:sticky;
  left:0;
  background:var(--sticky-bg);
  border-right:1px solid var(--border);
  z-index:15;
  min-width:50px;
  width:50px;
  max-width:60px;
  text-align:center;
  font-variant-numeric:tabular-nums;
}
th.sticky-title,
td.sticky-title{
  position:sticky;
  left:50px;
  background:var(--sticky-bg);
  border-right:1px solid var(--border);
  z-index:14;
  min-width:140px;
  max-width:200px;
  width:170px;
  white-space:normal;
  word-break:break-word;
  overflow-wrap:break-word;
  line-height:1.3;
  font-size:14px;
}

/* ligne actions */
.row-actions{
  display:flex;
  gap:.35rem;
  justify-content:flex-end;
}
.icon-btn{
  border:1px solid rgba(22,163,74,.4);
  color:#0b4f27;
  background:linear-gradient(180deg,rgba(34,197,94,.2),rgba(22,163,74,.12));
  width:30px;
  height:30px;
  border-radius:8px;
  cursor:pointer;
  font-size:15px;
  line-height:30px;
  text-align:center;
}
.icon-btn:hover{
  background:linear-gradient(180deg,rgba(34,197,94,.3),rgba(22,163,74,.2));
}
.icon-btn[disabled]:hover{
  background:linear-gradient(180deg,rgba(34,197,94,.2),rgba(22,163,74,.12));
}

/* pastilles guerre */
.badge{
  display:inline-block;
  padding:.15rem .45rem;
  border-radius:999px;
  font-size:12px;
  border:1px solid transparent;
  margin-left:.35rem;
}
.badge-ww1{background:#eaf4ff;border-color:#b9d6ff;color:#113a74;}
.badge-ww2{background:#eef6d3;border-color:#cfe7a5;color:#3c4b1f;}
.badge-autres{background:#f2f2f2;border-color:#dedede;color:#4b5563;}

/* FOOTER */
.footer{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:10px 14px;
  font-size:14px;
  color:#4b3f16;
  background:#fff9d3;
  border-top:1px solid var(--border);
}

/* STATS PANEL */
.stats{
  display:none;
  grid-template-columns:1fr 1fr;
  gap:16px;
  margin:10px auto;
  max-width:1200px;
  padding:0 16px 16px;
}
.stats.open{
  display:grid;
  animation:fadeIn .18s ease-out;
}
.card{
  background:#fffef6;
  border:1px solid var(--border);
  border-radius:10px;
  box-shadow:var(--shadow);
}
.card h3{
  margin:0;
  padding:10px 12px;
  font-size:15px;
  background:#fff7cf;
  border-bottom:1px solid var(--border);
  color:#3a2e0a;
  line-height:1.2;
}
.card .body{
  padding:10px 12px;
  font-size:14px;
  line-height:1.3;
}
.metric{
  display:flex;
  align-items:center;
  gap:10px;
  margin:8px 0;
}
.metric .label{
  min-width:150px;
  color:#5a4a17;
  font-size:14px;
}
.bar{
  flex:1;
  height:12px;
  border-radius:999px;
  background:#fff2b8;
  border:1px solid #eed26a;
  overflow:hidden;
}
.bar i{
  display:block;
  height:100%;
  background:linear-gradient(90deg,#22c55e,#16a34a);
  width:0%;
}
.val{
  font-variant-numeric:tabular-nums;
  color:#3a2e0a;
  font-size:14px;
}

/* TOAST */
#toast{
  position:fixed;
  left:50%;
  bottom:18px;
  transform:translateX(-50%);
  background:#f0fdf4;
  color:#14532d;
  border:1px solid #86efac;
  padding:10px 14px;
  border-radius:8px;
  box-shadow:var(--shadow);
  opacity:0;
  transition:opacity .2s ease;
  z-index:99;
  font-size:14px;
  line-height:1.3;
}
#toast.show{
  opacity:1;
}

@keyframes fadeIn{
  from{opacity:0;transform:translateY(5px);}
  to{opacity:1;transform:translateY(0);}
}

/* iPhone */
@media(max-width:480px){
  body{font-size:14px;}
  table{min-width:900px;}
  th.sticky-num,
  td.sticky-num{
    min-width:44px;
    width:44px;
    max-width:50px;
  }
  th.sticky-title,
  td.sticky-title{
    left:44px;
    min-width:130px;
    max-width:150px;
    width:140px;
    font-size:14px;
    line-height:1.3;
    padding-right:.5rem;
    padding-left:.5rem;
  }
  #filmCount{
    width:22px;
    height:22px;
    font-size:12px;
  }
}
</style>
</head>
<body>

<header>
  <div class="wrap">
    <h1>
      DVD
      <span id="filmCount">0</span>
    </h1>
    <div class="header-meta">
      ¬© Pierre Charlier 2025 ‚Ä¢ v2.2.6f
    </div>

    <div class="toolbar">
      <label class="btn" for="fileInput">üìÇ Importer CSV</label>
      <input id="fileInput" type="file" accept=".csv,text/csv" />

      <button class="btn secondary" id="btnExport" type="button">‚¨áÔ∏è Sauvegarder CSV</button>
      <button class="btn secondary" id="btnAdd" type="button">‚ûï Ajouter</button>
      <button class="btn danger" id="btnClearAll" type="button">üóëÔ∏è Tout effacer</button>

      <button class="btn lock-toggle unlocked" id="btnLock" type="button">üîì √âdition ON</button>

      <button class="btn" id="btnStats" type="button">üìä Statistiques</button>

      <div class="filters" id="guerreFilters" aria-label="Filtre Guerre">
        <button class="chipbtn active" data-v="ALL" type="button">Tous</button>
        <button class="chipbtn" data-v="WW1" type="button">WW1</button>
        <button class="chipbtn" data-v="WW2" type="button">WW2</button>
        <button class="chipbtn" data-v="Autres" type="button">Autres</button>
        <button class="chipbtn" data-v="(vide)" type="button">(vide)</button>
      </div>
    </div>
  </div>
</header>

<div class="wrap panel">
  <div class="table-wrap">
    <table id="grid" role="grid" aria-label="Collection DVD">
      <thead id="thead"></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
  <div class="footer">
    <div><span id="countShown">0</span> / <span id="countTotal">0</span> √©l√©ments</div>
    <div>Dernier √©tat : <span id="lockStateLabel"></span></div>
  </div>
</div>

<!-- Statistiques -->
<div class="stats" id="stats">
  <div class="card">
    <h3>R√©partition des th√®mes (Oui)</h3>
    <div class="body" id="statsThemes"></div>
  </div>
  <div class="card">
    <h3>Guerre ‚Äî WW1 / WW2 / Autres</h3>
    <div class="body" id="statsGuerre"></div>
  </div>
</div>

<div id="toast" role="status" aria-live="polite"></div>

<script>
document.addEventListener('DOMContentLoaded', ()=>{
  const APP_VERSION='2.2.6f';
  const STORAGE_KEY='dvd_collection_v2';
  const LOCK_KEY='dvd_locked';

  const thead=byId('thead');
  const tbody=byId('tbody');
  const statsEl=byId('stats');
  const btnLock=byId('btnLock');
  const filmCount=byId('filmCount');

  const Columns=[
   {key:'numero',label:'N¬∫',type:'number',sticky:'num',sortable:true},
   {key:'titre',label:'Titre',type:'text',sticky:'title',sortable:true},
   {key:'voyage',label:'Voyage',type:'bool',sortable:true},
   {key:'aviation',label:'Aviation',type:'bool',sortable:true},
   {key:'animation',label:'Animation',type:'bool',sortable:true},
   {key:'aventure',label:'Aventure',type:'bool',sortable:true},
   {key:'sf',label:'S.Fiction',type:'bool',sortable:true},
   {key:'explor',label:'Exploration',type:'bool',sortable:true},
   {key:'guerre',label:'Guerre',type:'choice',sortable:true,options:['','WW1','WW2','Autres']},
   {key:'animaux',label:'Animaux',type:'bool',sortable:true},
   {key:'disney',label:'Disney',type:'bool',sortable:true},
   {key:'horreur',label:'Horreur',type:'bool',sortable:true},
   {key:'enfants',label:'Enfants',type:'bool',sortable:true},
   {key:'famille',label:'Famille',type:'bool',sortable:true},
   {key:'histoire',label:'Histoire',type:'bool',sortable:true},
   {key:'autres',label:'Autres',type:'bool',sortable:true},
   {key:'nomcle',label:'Nom-cl√©',type:'text',sortable:true},
   {key:'_actions',label:'',type:'actions',sortable:false}
  ];

  // Charger les donn√©es sauvegard√©es
  let rows = loadLocal();
  if(!rows || !Array.isArray(rows) || !rows.length){
    rows=[
      { numero:'1',  titre:'Le Voyage de Chihiro', voyage:true, aviation:false, animation:true,  aventure:true,  sf:false, explor:false, guerre:'',    animaux:true,  disney:false, horreur:false, enfants:true,  famille:true,  histoire:false, autres:false, nomcle:'Miyazaki' },
      { numero:'2',  titre:'Dunkerque',            voyage:false,aviation:true,  animation:false, aventure:false, sf:false, explor:false, guerre:'WW2', animaux:false, disney:false, horreur:false, enfants:false, famille:false, histoire:true,  autres:false, nomcle:'Christopher Nolan' },
      { numero:'42', titre:'Interstellar',         voyage:false,aviation:false, animation:false, aventure:true,  sf:true,  explor:true,  guerre:'',    animaux:false, disney:false, horreur:false, enfants:false, famille:false, histoire:false,autres:false, nomcle:'Matthew McConaughey; Nolan' },
      { numero:'7',  titre:'Les Sentiers de la gloire', voyage:false,aviation:false, animation:false, aventure:false, sf:false, explor:false, guerre:'WW1', animaux:false, disney:false, horreur:false, enfants:false, famille:false, histoire:true, autres:false, nomcle:'Kubrick' }
    ];
    saveLocal();
  }

  // Tri + filtre + verrou
  let sortState={ key:'numero', dir:'asc' };
  let guerreFilter='ALL';
  let locked = loadLockedState();
  updateLockButton();

  /* ===== HEADER avec tri ===== */
  function buildHeader(){
    thead.innerHTML='';
    const tr=document.createElement('tr');
    Columns.forEach(c=>{
      const th=document.createElement('th');
      th.textContent=c.label;

      if(c.sticky==='num'){ th.classList.add('sticky-num'); }
      if(c.sticky==='title'){ th.classList.add('sticky-title'); }

      if(c.sortable){
        th.classList.add('sortable');
        const mark=document.createElement('span');
        mark.className='sortmark';
        mark.textContent = (sortState.key===c.key) ? (sortState.dir==='asc'?'‚ñ≤':'‚ñº') : '‚ñµ';
        th.appendChild(mark);
        th.addEventListener('click', ()=>{
          if(sortState.key===c.key){
            sortState.dir = (sortState.dir==='asc'?'desc':'asc');
          } else {
            sortState.key=c.key;
            sortState.dir='asc';
          }
          buildHeader();
          render();
        });
      }

      tr.appendChild(th);
    });
    thead.appendChild(tr);
  }

  function cmp(a,b,c){
    let va=a[c.key], vb=b[c.key];
    if(c.key==='guerre'){
      const order={'WW1':1,'WW2':2,'Autres':3,'':4,undefined:4,null:4};
      va = order[va] ?? 4;
      vb = order[vb] ?? 4;
    } else if(c.type==='number'){
      va=parseInt(va||'0',10)||0;
      vb=parseInt(vb||'0',10)||0;
    } else if(c.type==='bool'){
      va = !!va ? 1 : 0;
      vb = !!vb ? 1 : 0;
    } else {
      va = String(va??'').toLowerCase();
      vb = String(vb??'').toLowerCase();
    }
    if(va<vb) return -1;
    if(va>vb) return 1;
    return 0;
  }

  /* ===== Lock ===== */
  function updateLockButton(){
    if(locked){
      btnLock.classList.remove('unlocked');
      btnLock.classList.add('locked');
      btnLock.textContent='üîí Verrouill√©';
      byId('lockStateLabel').textContent='Verrouill√©';
    }else{
      btnLock.classList.remove('locked');
      btnLock.classList.add('unlocked');
      btnLock.textContent='üîì √âdition ON';
      byId('lockStateLabel').textContent='√âdition ON';
    }
  }

  btnLock.addEventListener('click',()=>{
    locked=!locked;
    saveLockedState();
    updateLockButton();
    render();
    toast(locked?'Verrou activ√©':'Verrou retir√©');
  });

  function saveLockedState(){
    try{ localStorage.setItem(LOCK_KEY, locked?'1':'0'); }catch(e){}
  }
  function loadLockedState(){
    try{
      const v=localStorage.getItem(LOCK_KEY);
      if(v==='1') return true;
      if(v==='0') return false;
    }catch(e){}
    return false;
  }

  /* ===== Filtre Guerre ===== */
  function initFilters(){
    document.querySelectorAll('#guerreFilters .chipbtn').forEach(b=>{
      b.addEventListener('click', ()=>{
        document.querySelectorAll('#guerreFilters .chipbtn').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        guerreFilter = b.dataset.v;
        render();
      });
    });
  }

  function applyFilterIndexed(arrWithIdx){
    if(guerreFilter==='ALL') return arrWithIdx;
    return arrWithIdx.filter(r=>{
      const v=(r.guerre||'').trim();
      if(guerreFilter==='(vide)') return v==='';
      return v===guerreFilter;
    });
  }

  /* Pastille Guerre */
  function setBadge(el, val){
    el.textContent = val || '‚Äî';
    el.className='badge';
    if(val==='WW1') el.classList.add('badge-ww1');
    else if(val==='WW2') el.classList.add('badge-ww2');
    else if(val==='Autres') el.classList.add('badge-autres');
  }

  /* ===== Rendu du tableau ===== */
  function render(){
    // indexer pour conserver l'index r√©el
    const indexed = rows.map((r,i)=>({ ...r, _idx:i }));

    // filtrer
    const filtered = applyFilterIndexed(indexed);

    // trier
    const sortCol = Columns.find(c=>c.key===sortState.key) || Columns[0];
    filtered.sort((a,b)=> (cmp(a,b,sortCol)) * (sortState.dir==='asc'?1:-1));

    // vider tbody
    tbody.innerHTML='';

    // remplir
    filtered.forEach(r=>{
      const tr=document.createElement('tr');

      Columns.forEach(c=>{
        const td=document.createElement('td');

        if(c.sticky==='num'){ td.classList.add('sticky-num'); }
        if(c.sticky==='title'){ td.classList.add('sticky-title'); }

        if(c.type==='actions'){
          const box=document.createElement('div'); box.className='row-actions';

          const editBtn=iconBtn('‚úèÔ∏è','√âditer',()=>enterRowEdit(tr, rows[r._idx], r._idx));
          const delBtn =iconBtn('üóëÔ∏è','Supprimer',()=>{
            if(locked){toast('D√©verrouille pour supprimer');return;}
            rows.splice(r._idx,1);
            saveLocal();
            render();
            if(statsOpen()) renderStats();
            toast('Ligne supprim√©e');
          });

          if(locked){
            editBtn.disabled=true;
            delBtn.disabled=true;
          }

          box.appendChild(editBtn);
          box.appendChild(delBtn);
          td.appendChild(box);

        } else if(c.type==='bool'){
          const cb=document.createElement('input');
          cb.type='checkbox';
          cb.checked=!!r[c.key];
          cb.disabled=locked;
          cb.onchange=()=>{
            rows[r._idx][c.key]=cb.checked;
            saveLocal();
            if(statsOpen()) renderStats();
          };
          td.appendChild(cb);

        } else if(c.key==='guerre'){
          const sel=document.createElement('select');
          (c.options||['']).forEach(v=>{
            const o=document.createElement('option');o.value=v;o.text=v;sel.appendChild(o);
          });
          sel.value=r.guerre||'';

          const badge=document.createElement('span');
          badge.className='badge';
          setBadge(badge, r.guerre||'');

          if(locked){
            sel.disabled=true;
          }else{
            sel.onchange=()=>{
              rows[r._idx].guerre=sel.value;
              saveLocal();
              render();
              if(statsOpen()) renderStats();
            };
          }

          td.appendChild(sel);
          td.appendChild(badge);

        } else {
          td.textContent=r[c.key]||'';
          if(!locked){
            td.ondblclick=()=>{
              const inp=document.createElement('input');
              inp.type='text';
              inp.value=r[c.key]||'';
              inp.style.width='100%';
              inp.onblur=()=>{
                rows[r._idx][c.key]=inp.value;
                saveLocal();
                render();
                if(statsOpen()) renderStats();
              };
              td.innerHTML='';
              td.appendChild(inp);
              inp.focus();
              inp.select();
            };
          }
        }

        tr.appendChild(td);
      });

      tbody.appendChild(tr);
    });

    // compteurs
    byId('countShown').textContent=filtered.length;
    byId('countTotal').textContent=rows.length;
    filmCount.textContent=rows.length;

    byId('btnAdd').disabled = locked;
    byId('btnClearAll').disabled = locked;
  }

  function iconBtn(txt,title,fn){
    const b=document.createElement('button');
    b.className='icon-btn';
    b.textContent=txt;
    b.title=title;
    b.type='button';
    b.onclick=fn;
    return b;
  }

  /* ===== √âDITION LIGNE ===== */
  function enterRowEdit(tr,row){
    if(locked){toast('D√©verrouille pour √©diter');return;}
    const cells=tr.querySelectorAll('td');
    Columns.forEach((c,i)=>{
      const td=cells[i];
      if(!td || c.type==='actions') return;
      td.innerHTML='';

      if(c.type==='bool'){
        const cb=document.createElement('input');
        cb.type='checkbox';
        cb.checked=!!row[c.key];
        cb.onchange=()=>row[c.key]=cb.checked;
        td.appendChild(cb);

      } else if(c.key==='guerre'){
        const sel=document.createElement('select');
        (c.options||['']).forEach(v=>{
          const o=document.createElement('option');o.value=v;o.text=v;sel.appendChild(o);
        });
        sel.value=row[c.key]||'';
        sel.onchange=()=>row[c.key]=sel.value;
        td.appendChild(sel);

        const b=document.createElement('span');
        b.className='badge';
        b.style.marginLeft='6px';
        setBadge(b,row[c.key]||'');
        td.appendChild(b);

        sel.addEventListener('change',()=>setBadge(b, sel.value||''));

      } else {
        const inp=document.createElement('input');
        inp.type='text';
        inp.value=row[c.key]||'';
        inp.style.width='100%';
        td.appendChild(inp);
      }
    });

    const act=tr.lastElementChild;
    act.innerHTML='';
    act.appendChild(iconBtn('‚úÖ','Valider',()=>{
      saveInline(tr,row);
      saveLocal();
      render();
      if(statsOpen()) renderStats();
      toast('Ligne mise √† jour');
    }));
    act.appendChild(iconBtn('‚Ü©Ô∏è','Annuler',()=>render()));
  }

  function saveInline(tr,row){
    const controls=tr.querySelectorAll('td:not(:last-child) input, td:not(:last-child) select');
    let i=0;
    Columns.forEach(c=>{
      if(c.type==='actions') return;
      const el=controls[i++];
      if(!el) return;
      if(c.type==='bool') row[c.key]=el.checked;
      else row[c.key]=el.value;
    });
  }

  /* ===== IMPORT CSV (avec d√©tection robuste Nom-cl√©) ===== */
  byId('fileInput').addEventListener('change', e=>{
    const f=e.target.files?.[0];
    if(!f) return;
    f.text().then(txt=>{
      const delim = detectDelimiter(txt);
      const grid=parseCSV(txt,delim);
      if(grid.length===0) return;

      const header=grid[0];
      const body=grid.slice(1);

      const map={};
      header.forEach((h,i)=>{
        const n=norm(h);
        if(n.startsWith('n')) map[i]='numero';
        else if(n.includes('titre')||n.includes('title')||n.includes('film')) map[i]='titre';
        else if(n.includes('voyage')) map[i]='voyage';
        else if(n.includes('aviation')) map[i]='aviation';
        else if(n.includes('animation')||n==='anim') map[i]='animation';
        else if(n.includes('aventure')) map[i]='aventure';
        else if(n.includes('s fiction')||n==='sf'||n.includes('science')) map[i]='sf';
        else if(n.includes('explor')||n.includes('espace')) map[i]='explor';
        else if(n.includes('guerre')||n==='war') map[i]='guerre';
        else if(n.includes('animaux')||n==='animal') map[i]='animaux';
        else if(n.includes('disney')) map[i]='disney';
        else if(n.includes('horreur')||n==='horror') map[i]='horreur';
        else if(n.includes('enfant')||n==='kids') map[i]='enfants';
        else if(n.includes('famille')||n==='family') map[i]='famille';
        else if(n.includes('histo')) map[i]='histoire';
        else if(n.includes('autres')||n==='autre'||n==='other'||n==='misc') map[i]='autres';
        else if(
          n.includes('nom cle') ||
          n.includes('nom-cle') ||
          n.includes('nomcle') ||
          n.includes('nom cl√©') ||
          n.includes('nom-cl√©') ||
          n.includes('keywords') ||
          n.includes('tags') ||
          n.includes('director') ||
          n.includes('actor') ||
          n.includes('cast')
        ){
          map[i]='nomcle';
        }
      });

      rows = body
        .filter(r=>r.some(c=>String(c).trim()!==''))
        .map(r=>{
          const o={};
          Columns.forEach(c=>{
            if(c.key!=='_actions') o[c.key]=(c.type==='bool'?false:'');
          });
          r.forEach((cell,i)=>{
            const key=map[i];
            if(!key) return;
            if(key==='guerre'){
              const v=String(cell).trim().toLowerCase();
              o.guerre =
                (v.includes('ww1')||v.includes('14-18')||v.includes('1914')) ? 'WW1' :
                (v.includes('ww2')||v.includes('39-45')||v.includes('194'))  ? 'WW2' :
                (v===''||v==='non'||v==='0'||v==='false' ? '' : 'Autres');
            } else if(Columns.find(c=>c.key===key)?.type==='bool'){
              const v=String(cell).trim().toLowerCase();
              o[key]=['1','oui','yes','true','vrai','x','‚úì'].includes(v);
            } else if(key==='numero'){
              o.numero = String(cell).replace(/[^\d]/g,'');
            } else {
              o[key]=String(cell).trim();
            }
          });
          return o;
        });

      // donner un num√©ro aux lignes qui ont un N¬∫ vide
      let max=rows.reduce((m,r)=>Math.max(m,parseInt(r.numero||0,10)||0),0);
      rows.forEach(r=>{
        if(!r.numero){
          max+=1;
          r.numero=String(max);
        }
      });

      saveLocal();
      render();
      if(statsOpen()) renderStats();
      toast('CSV import√©');
    });
  });

  /* ===== EXPORT CSV (ouvre dans nouvel onglet pour sauvegarder o√π tu veux) ===== */
  byId('btnExport').addEventListener('click', ()=>{
    if(!rows.length){
      toast('Aucune donn√©e √† exporter');
      return;
    }

    const header = [
      "N¬∫","Titre","Voyage","Aviation","Animation","Aventure","S.Fiction",
      "Exploration","Guerre","Animaux","Disney","Horreur",
      "Enfants","Famille","Histoire","Autres","Nom-cl√©"
    ];

    const lines=[header.join(';')];

    rows.forEach(r=>{
      const vals=[
        r.numero || "",
        r.titre || "",
        r.voyage ? "Oui" : "Non",
        r.aviation ? "Oui" : "Non",
        r.animation ? "Oui" : "Non",
        r.aventure ? "Oui" : "Non",
        r.sf ? "Oui" : "Non",
        r.explor ? "Oui" : "Non",
        r.guerre || "",
        r.animaux ? "Oui" : "Non",
        r.disney ? "Oui" : "Non",
        r.horreur ? "Oui" : "Non",
        r.enfants ? "Oui" : "Non",
        r.famille ? "Oui" : "Non",
        r.histoire ? "Oui" : "Non",
        r.autres ? "Oui" : "Non",
        r.nomcle || ""
      ].map(v => `"${String(v).replace(/"/g,'""')}"`);
      lines.push(vals.join(';'));
    });

    const blob=new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);

    // Ouvre dans un nouvel onglet.
    // Sur iPhone : bouton Partager ‚Üí Enregistrer dans Fichiers ‚Üí choisis ton dossier.
    window.open(url, "_blank");

    toast('CSV pr√™t. Partager ‚Üí Enregistrer dans Fichiers');
  });

  /* ===== AJOUTER / TOUT EFFACER ===== */
  byId('btnAdd').addEventListener('click', ()=>{
    if(locked){ toast('D√©verrouille pour ajouter'); return; }
    const max=rows.reduce((m,r)=>Math.max(m,parseInt(r.numero||0,10)||0),0);
    rows.unshift({
      numero:String(max+1), titre:'',
      voyage:false, aviation:false, animation:false, aventure:false, sf:false, explor:false,
      guerre:'', animaux:false, disney:false, horreur:false, enfants:false, famille:false, histoire:false, autres:false,
      nomcle:''
    });
    saveLocal();
    render();
    if(statsOpen()) renderStats();
    toast('Ligne ajout√©e');
  });

  byId('btnClearAll').addEventListener('click', ()=>{
    if(locked){ toast('D√©verrouille pour effacer'); return; }
    if(confirm('Confirmer : effacer TOUT le tableau ? Cette action est irr√©versible.')){
      rows=[];
      localStorage.removeItem(STORAGE_KEY);
      render();
      if(statsOpen()) renderStats();
      toast('Tout effac√©');
    }
  });

  /* ===== STATS ===== */
  const btnStats = byId('btnStats');
  btnStats.addEventListener('click', ()=>{
    statsEl.classList.toggle('open');
    if(statsEl.classList.contains('open')) renderStats();
  });
  function statsOpen(){ return statsEl.classList.contains('open'); }

  function renderStats(){
    const themesBody=byId('statsThemes');
    const guerreBody=byId('statsGuerre');
    themesBody.innerHTML='';
    guerreBody.innerHTML='';

    const boolCols=Columns.filter(c=>c.type==='bool').map(c=>c.key);
    const counts={};
    boolCols.forEach(k=>{
      counts[k]=rows.reduce((n,r)=>n+(r[k]?1:0),0);
    });

    const total=rows.length||1;
    const max=Math.max(1,...Object.values(counts),total);

    boolCols.forEach(key=>{
      const colInfo=Columns.find(c=>c.key===key);
      const label=colInfo?colInfo.label:key;
      const val=counts[key]||0;

      const line=document.createElement('div');
      line.className='metric';

      const l=document.createElement('div');
      l.className='label';
      l.textContent=label;

      const bar=document.createElement('div');
      bar.className='bar';

      const fill=document.createElement('i');
      fill.style.width=(Math.max(0,Math.min(100,(val/max*100)))).toFixed(1)+'%';
      bar.appendChild(fill);

      const v=document.createElement('div');
      v.className='val';
      v.textContent = `${val} / ${total}`;

      line.appendChild(l);
      line.appendChild(bar);
      line.appendChild(v);
      themesBody.appendChild(line);
    });

    const g={WW1:0,WW2:0,Autres:0,'(vide)':0};
    rows.forEach(r=>{
      const v=(r.guerre||'').trim();
      if(v==='WW1') g.WW1++;
      else if(v==='WW2') g.WW2++;
      else if(v==='Autres') g.Autres++;
      else g['(vide)']++;
    });

    ['WW1','WW2','Autres','(vide)'].forEach(k=>{
      const line=document.createElement('div');
      line.className='metric';

      const l=document.createElement('div');
      l.className='label';
      l.textContent='Guerre '+k;

      const bar=document.createElement('div');
      bar.className='bar';

      const fill=document.createElement('i');
      fill.style.width=(g[k]/total*100).toFixed(1)+'%';
      bar.appendChild(fill);

      const v=document.createElement('div');
      v.className='val';
      v.textContent=`${g[k]} / ${total}`;

      line.appendChild(l);
      line.appendChild(bar);
      line.appendChild(v);
      guerreBody.appendChild(line);
    });
  }

  /* ===== UTILS ===== */
  function byId(id){ return document.getElementById(id); }

  function toast(msg){
    const t=byId('toast');
    t.textContent=msg;
    t.classList.add('show');
    clearTimeout(toast._timer);
    toast._timer=setTimeout(()=>t.classList.remove('show'),1500);
  }

  function saveLocal(){
    try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(rows)); }
    catch(e){ console.warn(e); }
  }

  function loadLocal(){
    try{
      const s=localStorage.getItem(STORAGE_KEY);
      if(!s) return null;
      const data=JSON.parse(s);
      if(Array.isArray(data)) return data;
    }catch(e){ console.warn(e); }
    return null;
  }

  // version renforc√©e : retire accents, unifie tirets, nettoie
  function norm(s){
    return String(s||'')
      .normalize("NFD")                         // s√©pare lettres et accents
      .replace(/[\u0300-\u036f]/g,"")           // enl√®ve les accents (√© -> e)
      .replace(/[\u2010-\u2015\u2212\u00ad\-]/g,"-") // tous types de tirets ‚Üí "-"
      .replace(/[^\w\- ]+/g," ")                // autres symboles ‚Üí espace
      .toLowerCase()
      .replace(/\s+/g," ")
      .trim();
  }

  function detectDelimiter(sample){
    const line=(sample.split(/\r?\n/)[0]||sample);
    const candidates=[';',',','\t','|'];
    let best=';',bestCount=0;
    for(const d of candidates){
      const n=line.split(d).length;
      if(n>bestCount){ bestCount=n; best=d; }
    }
    return best;
  }

  function parseCSV(text,delim){
    const out=[];
    let row=[];
    let cur='';
    let inQ=false;
    for(let i=0;i<text.length;i++){
      const c=text[i];
      if(inQ){
        if(c=='"'){
          if(text[i+1]=='"'){ cur+='"'; i++; }
          else inQ=false;
        } else {
          cur+=c;
        }
      }else{
        if(c=='"'){ inQ=true; }
        else if(c===delim){ row.push(cur); cur=''; }
        else if(c=='\n'){ row.push(cur); out.push(row); row=[]; cur=''; }
        else if(c=='\r'){ /* ignore */ }
        else { cur+=c; }
      }
    }
    if(cur!=='' || text.endsWith(delim)) row.push(cur);
    if(row.length) out.push(row);
    return out;
  }

  /* ===== LANCEMENT ===== */
  buildHeader();
  initFilters();
  render();
});
</script>
</body>
</html>